<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قرعه‌کشی میکس پلاس | Mix+</title>
    
    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- تیلویند سی‌اس‌اس -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- کتابخانه کانفتی -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mix: {
                            DEFAULT: '#0fa99c',
                            dark: '#0a7a70',
                            light: '#14c9ba'
                        }
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #111827;
            background-image: radial-gradient(circle at 50% 0%, #1f2937 0%, #111827 100%);
            overflow-x: hidden;
            font-family: 'Vazirmatn', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glow-text {
            text-shadow: 0 0 10px rgba(15, 169, 156, 0.5), 0 0 20px rgba(15, 169, 156, 0.3);
        }

        .custom-file-upload {
            border: 2px dashed #0fa99c;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .custom-file-upload:hover {
            background-color: rgba(15, 169, 156, 0.1);
            transform: scale(1.02);
        }

        /* استایل اختصاصی فلش */
        .pointer-arrow {
            width: 0; 
            height: 0; 
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid white;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3));
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

        /* کانتینر ریسپانسیو چرخونه */
        .wheel-container-responsive {
            position: relative;
            width: 90vw;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        #wheelCanvas {
            width: 100%;
            height: 100%;
        }

        /* کلاس برای حذف استایل پیش فرض لوگو */
        .logo-uploaded {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- هدر سایت -->
    <header class="w-full max-w-5xl flex justify-between items-center mb-6 pt-4 px-2 md:px-0">
        <div class="flex items-center gap-4">
            <!-- ناحیه لوگو -->
            <div class="relative group cursor-pointer" onclick="document.getElementById('logo-upload').click()">
                <!-- کانتینر لوگو: در حالت پیش فرض گرد و رنگی است، بعد از آپلود شفاف می‌شود -->
                <div id="logo-container" class="w-16 h-16 md:w-20 md:h-20 bg-mix rounded-full flex items-center justify-center font-bold text-2xl shadow-[0_0_15px_#0fa99c] border-2 border-white/20 transition-all duration-300">
                    <span id="logo-text" class="text-white">M+</span>
                    <img id="logo-img" src="" class="w-full h-full object-contain hidden" alt="Logo">
                </div>
                
                <!-- تولتیپ راهنما -->
                <div class="absolute -bottom-8 right-0 w-max text-xs bg-black/80 px-2 py-1 rounded text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity z-50 pointer-events-none">
                    تغییر لوگو
                </div>
                <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
            </div>

            <div class="flex flex-col">
                <h1 class="text-2xl md:text-3xl font-bold text-white glow-text">میکس پلاس</h1>
                <p class="text-xs md:text-sm text-gray-400">سیستم پیشرفته قرعه‌کشی</p>
            </div>
        </div>
        
        <div class="text-left hidden md:block">
            <p class="text-mix font-bold text-lg">قرعه‌کشی اینستاگرام</p>
            <p class="text-xs text-gray-500" id="date-display">2025/12/24</p>
        </div>
    </header>

    <!-- محتوای اصلی -->
    <main class="w-full max-w-5xl relative flex-grow flex flex-col items-center justify-start pt-4">
        
        <!-- بخش 1: آپلود فایل -->
        <div id="upload-section" class="glass-panel rounded-3xl p-8 md:p-12 text-center w-full max-w-2xl mx-auto mt-10 transition-all duration-500">
            <div class="mb-6 flex justify-center">
                <svg class="w-20 h-20 text-mix opacity-80 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold mb-4">ورود فایل اکسل (CSV)</h2>
            <p class="text-gray-400 mb-8 px-4 leading-relaxed">
                لطفاً فایل خروجی کامنت‌های اینستاگرام را انتخاب کنید.<br>
                سیستم به صورت خودکار لیست را برای قرعه‌کشی آماده می‌کند.
            </p>
            
            <label for="file-upload" class="custom-file-upload py-4 px-10 rounded-xl text-mix font-bold text-lg flex items-center justify-center gap-3 mx-auto max-w-xs hover:text-white hover:bg-mix/10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                انتخاب فایل
            </label>
            <input id="file-upload" type="file" accept=".csv" class="hidden" onchange="handleFileUpload(this)"/>
            
            <div id="error-msg" class="text-red-400 mt-4 hidden text-sm font-bold bg-red-900/20 py-2 rounded"></div>
        </div>

        <!-- بخش 2: بازی (چرخونه) -->
        <div id="game-section" class="hidden w-full flex-col items-center">
            
            <!-- شمارنده -->
            <div class="flex justify-center mb-4">
                <div class="glass-panel px-6 py-2 rounded-full flex items-center gap-3 border-mix/30 backdrop-blur-md">
                    <div class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-mix opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-mix"></span>
                    </div>
                    <span class="text-gray-300 text-sm">شرکت‌کنندگان:</span>
                    <span id="count-display" class="font-bold text-white text-xl font-mono">0</span>
                </div>
            </div>

            <!-- کانتینر اصلی چرخونه -->
            <div class="wheel-container-responsive group">
                
                <!-- نور پس‌زمینه (Glow Effect) -->
                <div class="absolute inset-0 rounded-full bg-mix blur-3xl opacity-10 group-hover:opacity-25 transition-opacity duration-500 pointer-events-none transform scale-90"></div>
                
                <!-- فلش ثابت بالا -->
                <div class="pointer-arrow"></div>

                <!-- کانواس (چرخونه) -->
                <canvas id="wheelCanvas"></canvas>
                
                <!-- دکمه وسط -->
                <button id="spin-btn" onclick="spinWheel()" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-20 h-20 md:w-24 md:h-24 bg-white rounded-full shadow-[0_0_25px_rgba(255,255,255,0.4)] z-20 flex items-center justify-center border-4 border-[#1f2937] hover:scale-105 active:scale-95 transition-all duration-200 cursor-pointer overflow-hidden">
                    <span class="text-gray-800 font-black text-xl md:text-2xl tracking-tighter z-10">START</span>
                </button>
            </div>

            <!-- دکمه ریست -->
            <div class="flex gap-4 mt-8">
                 <button onclick="resetApp()" class="flex items-center gap-2 px-5 py-2 rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-white transition-colors text-sm bg-gray-900/50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    آپلود مجدد فایل
                </button>
            </div>
        </div>

    </main>

    <!-- مودال برنده -->
    <div id="winner-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass-panel w-full max-w-lg p-1 rounded-3xl transform scale-50 opacity-0 transition-all duration-500 ease-out" id="winner-card">
            
            <div class="bg-[#1f2937] rounded-[22px] p-6 md:p-10 relative overflow-hidden flex flex-col items-center text-center">
                <!-- المان‌های تزئینی پس زمینه -->
                <div class="absolute top-0 right-0 w-40 h-40 bg-mix/20 rounded-full blur-3xl -mr-20 -mt-20"></div>
                <div class="absolute bottom-0 left-0 w-40 h-40 bg-purple-500/10 rounded-full blur-3xl -ml-20 -mb-20"></div>

                <div class="relative z-10 w-full flex flex-col items-center">
                    
                    <!-- لوگوی مودال (بدون کادر) -->
                    <div id="modal-logo-container" class="mb-4 flex items-center justify-center w-24 h-24 md:w-32 md:h-32 transition-all">
                         <!-- پیش فرض: کادر دارد -->
                         <div id="modal-default-logo" class="w-20 h-20 bg-mix rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(15,169,156,0.4)] border-2 border-white/20">
                             <span class="text-3xl font-bold text-white">M+</span>
                         </div>
                         <!-- حالت آپلود شده: فقط عکس -->
                         <img id="modal-logo-img" src="" class="w-full h-full object-contain hidden drop-shadow-2xl">
                    </div>
                    
                    <h3 class="text-2xl md:text-3xl font-bold text-white mb-2">تبریک!</h3>
                    <p class="text-mix font-bold text-lg md:text-xl mb-6 drop-shadow-md">برنده یک عدد اجاق گاز IG8506</p>
                    
                    <!-- نام برنده -->
                    <div class="w-full bg-gray-900/80 border border-gray-700 rounded-xl p-5 mb-4 shadow-inner">
                        <p class="text-xs text-gray-500 mb-2">نام کاربری برنده</p>
                        <p id="winner-name" class="text-2xl md:text-4xl font-black text-white glow-text break-words tracking-wide" style="direction: ltr;">
                            @Username
                        </p>
                    </div>

                    <!-- جزئیات کامنت -->
                    <div class="w-full bg-gray-800/40 border border-gray-700/50 rounded-xl p-4 mb-6 text-right">
                        <div class="mb-3 pb-3 border-b border-gray-700/50 min-h-[60px]">
                            <p class="text-xs text-gray-500 mb-2">متن کامنت:</p>
                            <p id="winner-comment" class="text-white text-sm leading-relaxed font-light line-clamp-3">...</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">تاریخ ثبت:</span>
                            <span id="winner-date" class="text-xs text-mix font-mono dir-ltr bg-mix/10 px-2 py-1 rounded">...</span>
                        </div>
                    </div>
                    
                    <button onclick="closeModal()" class="w-full bg-mix hover:bg-mix-light text-white font-bold py-4 rounded-xl shadow-lg transition-all hover:shadow-[0_0_25px_#0fa99c] active:scale-95 text-lg">
                        برنده اجاق گاز IG8506
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- فوتر -->
    <footer class="mt-8 text-gray-600 text-[10px] md:text-xs">
        <p>طراحی و اجرا توسط هوش مصنوعی <span class="text-mix font-bold">Mix+</span></p>
    </footer>

    <script>
        // --- متغیرهای اصلی ---
        let participants = []; 
        let wheelSegments = []; 
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let currentRotation = 0;
        let isSpinning = false;
        let finalWinner = null;
        let animationId = null;
        
        // تنظیمات چرخونه
        const segmentsCount = 20; // تعداد قطعات بصری
        const colors = ['#0fa99c', '#1f2937']; // سبز و خاکستری تیره
        const spinDuration = 6000; // مدت زمان چرخش (میلی ثانیه)

        // --- مدیریت لوگو ---
        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgData = e.target.result;
                    
                    // 1. آپدیت هدر
                    const headerContainer = document.getElementById('logo-container');
                    const headerImg = document.getElementById('logo-img');
                    const headerText = document.getElementById('logo-text');

                    // حذف استایل‌های پیش‌فرض دایره‌ای
                    headerContainer.classList.add('logo-uploaded');
                    
                    headerText.classList.add('hidden');
                    headerImg.src = imgData;
                    headerImg.classList.remove('hidden');
                    
                    // 2. آماده‌سازی لوگوی مودال
                    const modalDefault = document.getElementById('modal-default-logo');
                    const modalImg = document.getElementById('modal-logo-img');
                    
                    modalDefault.classList.add('hidden');
                    modalImg.src = imgData;
                    modalImg.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- مدیریت فایل اکسل ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                processCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        function processCSV(csvText) {
            const lines = csvText.split('\n');
            const users = [];

            // پارس کردن ساده CSV
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const parts = line.split(',');
                    // فرض بر این است که فرمت Username,Comment,Date است
                    if (parts.length >= 2) {
                        const username = parts[0].trim();
                        // گرفتن تاریخ (آخرین بخش)
                        const date = parts[parts.length - 1].trim();
                        // گرفتن کامنت (بخش‌های میانی)
                        const comment = parts.slice(1, parts.length - 1).join(',').trim();

                        if (username && username.toLowerCase() !== 'username') {
                            users.push({ username, comment, date });
                        }
                    }
                }
            }

            if (users.length < 2) {
                const errEl = document.getElementById('error-msg');
                errEl.innerText = "خطا: فایل باید حداقل ۲ شرکت‌کننده داشته باشد.";
                errEl.classList.remove('hidden');
                return;
            }

            participants = users;
            document.getElementById('count-display').innerText = participants.length.toLocaleString('fa-IR');
            
            // تغییر صفحه
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            document.getElementById('game-section').classList.add('flex'); // نمایش بصورت فلکس

            // راه‌اندازی چرخونه
            initWheel();
        }

        // --- منطق چرخونه ---

        function initWheel() {
            resizeCanvas();
            prepareWheelData();
            drawWheel();
            window.addEventListener('resize', () => {
                resizeCanvas();
                drawWheel(currentRotation);
            });
        }

        function resizeCanvas() {
            // تنظیم سایز کانواس بر اساس کانتینر والد برای کیفیت بالا (Retina display support)
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // اسکیل کردن کانتکست
            ctx.scale(dpr, dpr);
            
            // ذخیره ابعاد منطقی برای رسم
            canvas.logicalWidth = rect.width;
            canvas.logicalHeight = rect.height;
        }

        function prepareWheelData() {
            wheelSegments = [];
            // انتخاب تصادفی نام‌ها برای نمایش گرافیکی
            // اگر تعداد شرکت کنندگان کمتر از سگمنت‌ها بود، تکرار میکنیم
            for(let i=0; i<segmentsCount; i++) {
                const user = participants[Math.floor(Math.random() * participants.length)];
                wheelSegments.push(user);
            }
        }

        function drawWheel(angleOffset = 0) {
            const w = canvas.logicalWidth;
            const h = canvas.logicalHeight;
            const cx = w / 2;
            const cy = h / 2;
            const radius = (Math.min(w, h) / 2) - 15; // حاشیه امن
            const arcSize = (2 * Math.PI) / segmentsCount;

            ctx.clearRect(0, 0, w, h);

            // دایره پس زمینه
            ctx.beginPath();
            ctx.arc(cx, cy, radius + 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#111827';
            ctx.fill();
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#0fa99c';
            ctx.stroke();

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(angleOffset);

            for (let i = 0; i < segmentsCount; i++) {
                const angle = i * arcSize;
                
                // رسم قطعه
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + arcSize);
                ctx.fillStyle = (i % 2 === 0) ? colors[0] : colors[1];
                ctx.fill();
                ctx.lineWidth = 1;
                ctx.strokeStyle = "rgba(255,255,255,0.1)"; // خط جداکننده نازک
                ctx.stroke();

                // رسم متن
                ctx.save();
                // چرخش برای متن: وسط زاویه قطعه
                ctx.rotate(angle + arcSize / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 14px Vazirmatn";
                if(w > 400) ctx.font = "bold 16px Vazirmatn"; // فونت بزرگتر در دسکتاپ

                let text = wheelSegments[i].username;
                if (text.length > 12) text = text.substring(0, 10) + "..";
                
                // فاصله از مرکز
                ctx.fillText(text, radius - 20, 5);
                ctx.restore();
            }

            ctx.restore();
            
            // رسم دایره وسط (روی سوراخ وسط)
            ctx.beginPath();
            ctx.arc(cx, cy, 30, 0, 2 * Math.PI);
            ctx.fillStyle = '#111827';
            ctx.fill();
        }

        function spinWheel() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;

            // 1. انتخاب برنده نهایی
            const winnerIndex = Math.floor(Math.random() * participants.length);
            finalWinner = participants[winnerIndex];

            // 2. تقلب هوشمند: جایگذاری نام برنده در سگمنت شماره 5
            // فلش ما در بالا (زاویه -90 یا 270) ثابت است.
            // سگمنت 5 را برای برنده انتخاب میکنیم.
            const targetIndex = 5;
            wheelSegments[targetIndex] = finalWinner;

            // 3. محاسبه چرخش
            const arcSize = (2 * Math.PI) / segmentsCount;
            // زاویه وسط سگمنت هدف در حالت پیش فرض (بدون چرخش)
            const targetSegmentAngle = (targetIndex * arcSize) + (arcSize / 2);
            
            // ما میخواهیم targetSegmentAngle بعد از چرخش به مکان فلش برسد.
            // مکان فلش = 3 * Math.PI / 2 (یا همان 270 درجه - بالا)
            // فرمول: (InitialAngle + Rotation) % 2PI = TargetPosition
            // Rotation = TargetPosition - InitialAngle
            
            const positionOfPointer = 1.5 * Math.PI; // 270 degrees
            let stopAngle = positionOfPointer - targetSegmentAngle;
            
            // اضافه کردن چرخش‌های کامل (حداقل 5 دور کامل)
            const spins = 10; 
            const totalRotation = stopAngle + (spins * 2 * Math.PI);

            // شروع انیمیشن
            let start = null;
            
            function step(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                
                if (progress < spinDuration) {
                    // تابعEasing: easeOutQuart برای ترمز نرم
                    const t = progress / spinDuration;
                    const ease = 1 - Math.pow(1 - t, 4); 
                    
                    currentRotation = ease * totalRotation;
                    drawWheel(currentRotation);
                    animationId = requestAnimationFrame(step);
                } else {
                    // پایان
                    currentRotation = totalRotation;
                    drawWheel(currentRotation);
                    isSpinning = false;
                    document.getElementById('spin-btn').disabled = false;
                    showWinnerPopup();
                }
            }
            animationId = requestAnimationFrame(step);
        }

        function showWinnerPopup() {
            // افکت جشن
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#0fa99c', '#ffffff', '#FFD700']
            });

            // پر کردن اطلاعات
            document.getElementById('winner-name').innerText = "@" + finalWinner.username;
            document.getElementById('winner-comment').innerText = finalWinner.comment || "بدون متن";
            document.getElementById('winner-date').innerText = finalWinner.date || "";

            // نمایش مودال
            setTimeout(() => {
                const modal = document.getElementById('winner-modal');
                const card = document.getElementById('winner-card');
                
                modal.classList.remove('hidden');
                // انیمیشن ورود
                setTimeout(() => {
                    card.classList.remove('scale-50', 'opacity-0');
                    card.classList.add('scale-100', 'opacity-100');
                }, 50);
            }, 500);
        }

        function closeModal() {
            const modal = document.getElementById('winner-modal');
            const card = document.getElementById('winner-card');
            
            card.classList.remove('scale-100', 'opacity-100');
            card.classList.add('scale-50', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 500);
        }

        function resetApp() {
            location.reload();
        }

    </script>
</body>
</html>
